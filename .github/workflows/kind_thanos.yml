name: Thanos setup on kind

on:
 workflow_dispatch:

env:
  kind-image: 'kindest/node:v1.31.0'
  kind-version: 'v0.24.0'

jobs:
   thanos_test:
   
 
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04

    steps:
      - name: Start kind cluster
        uses: helm/kind-action@v1.11.0
        with:
          version: ${{ env.kind-version }}
          node_image: ${{ env.kind-image }}
          wait: 10s
          cluster_name: kind

      - name: Wait for cluster to bootstrap and setup thanos operator
        run: |
          kubectl wait --for=condition=Ready pods --all --all-namespaces --timeout=300s

          LATEST=$(curl -s https://api.github.com/repos/prometheus-operator/prometheus-operator/releases/latest | jq -cr .tag_name)
          curl -sL https://github.com/prometheus-operator/prometheus-operator/releases/download/${LATEST}/bundle.yaml | kubectl create -f -

          git clone https://github.com/thanos-community/thanos-operator.git
          cd thanos-operator
          echo "***********************************"
          echo "Install Thanos CRDS"
          echo "***********************************"
          make install
          kubectl get crds -n thanos-operator
          
          echo "***********************************"
          echo "Install Thanos operator"
          echo "***********************************"
          make deploy IMG="quay.io/thanos/thanos-operator:main-2024-12-24-5e131ef"
          kubectl get pods -n thanos-operator-system
          
          echo "***********************************"
          echo "Install Thanos components"
          echo "***********************************"
          make install-example
          kubectl get pods -n thanos-operator-system

      - name: Create tsdb blocks using thanosbench
        run: |      
          echo "***********************************"
          echo "Creating TSDB blocks"
          echo "***********************************"
          git clone -b kruize_profile https://github.com/chandrams/thanosbench.git
          cd thanosbench
          make build
          maxtime=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          echo "${maxtime}"
          echo " ./thanosbench block plan -p kruize-1d-tiny --max-time="${maxtime}" | ./thanosbench block gen --workers=20 --output.dir=${GITHUB_WORKSPACE}/tsdb"
          ./thanosbench block plan -p kruize-1d-tiny --max-time="${maxtime}" | ./thanosbench block gen --workers=20 --output.dir=${GITHUB_WORKSPACE}/tsdb
          ls ${GIT_WORKSPACE}/tsdb
          
      - uses: actions/checkout@v3
        with:
          repository: kruize/autotune
          ref: mvp_demo
          path: autotune
      
     
